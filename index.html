<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Магазин в Telegram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Обязательная библиотека Telegram Web Apps -->
  <script src="https://telegram.orgweb-app.js</script>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #111);
    }
    .container { padding: 16px; max-width: 720px; margin: 0 auto; }
    .card {
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      border-radius: 12px; overflow: hidden; margin-bottom: 16px;
      background: var(--tg-theme-secondary-bg-color, #f7f7f7);
    }
    .card img { width: 100%; display: block; }
    .card .body { padding: 12px 16px; }
    .title { font-size: 18px; margin: 0 0 8px; }
    .desc { font-size: 14px; opacity: .8; margin: 0 0 12px; }
    .actions { display:flex; gap:8px; }
    button {
      padding: 10px 14px; border-radius: 10px; border: none; cursor: pointer;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff); font-weight: 600;
    }
    .note { font-size: 13px; opacity:.7; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Магазин</h1>

    <div class="card">
      <img src="https://images.example.com/mug.jpg" alt="Кружка QA Life   <p class="title">Кружка «QA Life»</p>
        <p class="desc">Керамическая кружка 330 мл</p>
        <div class="actions">
          <button id="buy-mug">Купить за ⭐ 599</button>
        </div>
        <div class="note" id="status"></div>
      </div>
    </div>
  </div>

  <script>
    // Инициализация Mini App UI
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand(); // растягиваем по высоте
    const statusEl = document.getElementById('status');
    const buyBtn = document.getElementById('buy-mug');

    async function createInvoiceAndPay(sku) {
      statusEl.textContent = 'Создаю счет...';

      // Рекомендуемый способ: передавать initData в заголовке Authorization: "tma <initData>"
      // initData — это строка query-параметров, которую Telegram добавляет к Mini App. [5](https://docs.telegram-mini-apps.com/platform/init-data)
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `tma ${tg.initData}`
      };

      // Запрашиваем у нашего бекенда ссылку на счет (createInvoiceLink)
      const resp = await fetch('/api/create_invoice', {
        method: 'POST',
        headers,
        body: JSON.stringify({ sku })
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`Ошибка API: ${resp.status} ${text}`);
      }

      const { invoice_url } = await resp.json();

      // Открываем платежный экран внутри Telegram
      // Можно передать как URL инвойса, так и «slug» — обе формы поддерживаются. [2](https://docs.telegram-mini-apps.com/packages/telegram-apps-sdk/2-x/components/invoice)
      const result = await tg.openInvoice(invoice_url);

      // result: 'paid' | 'cancelled' | 'failed' | 'pending' (в зависимости от платформы)
      return result;
    }

    buyBtn.addEventListener('click', async () => {
      buyBtn.disabled = true;
      statusEl.textContent = '';
      try {
        const status = await createInvoiceAndPay('coffee_mug');
        if (status === 'paid') {
          statusEl.textContent = '✅ Оплата прошла успешно! Спасибо!';
        } else if (status === 'cancelled') {
          statusEl.textContent = '❕ Платеж отменен.';
        } else if (status === 'failed') {
          statusEl.textContent = '❌ Платеж не прошел.';
        } else {
          statusEl.textContent = `Статус: ${status}`;
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = '⚠️ Ошибка при оплате. Попробуйте еще раз.';
      } finally {
        buyBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
``
